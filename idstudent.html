<!doctype html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ค้นหารหัสนักศึกษา</title>
  </head>
  <body>
    <h1>ค้นหารหัสนักศึกษา</h1>

    <form id="form" onsubmit="search(event)">
      <label for="input">เลขบัตรประชาชน 13 หลัก</label>
      <input
        id="input"
        type="text"
        inputmode="numeric"
        maxlength="13"
        placeholder="เลขบัตรประชาชน"
        autocomplete="off"
      />
      <button type="submit" id="btn">ค้นหา</button>
      <p id="error" hidden></p>
    </form>

    <div id="result"></div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbyJcgraL-b7XUxVsOAqoaWOPQwDxtf1xKs3MousYvpBAQdjRbb_zGJJ2fliSITxwlG3TA/exec";

      const input = document.getElementById("input");
      const btn = document.getElementById("btn");
      const errorEl = document.getElementById("error");
      const resultEl = document.getElementById("result");

      input.addEventListener("input", function () {
        this.value = this.value.replaceAll(/\D/g, "").slice(0, 13);
        errorEl.hidden = true;
      });

      async function search(e) {
        e.preventDefault();
        var id = input.value.trim();

        if (id.length !== 13) {
          errorEl.textContent = "กรุณากรอกเลขบัตรประชาชนให้ครบ 13 หลัก";
          errorEl.hidden = false;
          input.focus();
          return;
        }

        btn.disabled = true;
        btn.textContent = "กำลังค้นหา...";
        errorEl.hidden = true;
        clearResult();

        try {
          var res = await fetch(API_URL + "?cardId=" + encodeURIComponent(id));
          var data = await res.json();

          if (data.success) {
            showFound(data.data);
          } else if (data.error === "NOT_FOUND") {
            showNotFound();
          } else {
            errorEl.textContent = data.message || "เกิดข้อผิดพลาด";
            errorEl.hidden = false;
          }
        } catch (error) {
          console.error(error);
          errorEl.textContent = "ไม่สามารถเชื่อมต่อระบบได้ ลองใหม่อีกครั้ง";
          errorEl.hidden = false;
        } finally {
          btn.disabled = false;
          btn.textContent = "ค้นหา";
        }
      }

      function showFound(data) {
        var box = document.createElement("div");

        var nameLabel = document.createElement("p");
        nameLabel.textContent = "ชื่อ-สกุล";
        box.appendChild(nameLabel);

        var name = document.createElement("p");
        name.textContent = data.name;
        box.appendChild(name);

        var idLabel = document.createElement("p");
        idLabel.textContent = "รหัสนักศึกษา";
        box.appendChild(idLabel);

        var idVal = document.createElement("p");
        idVal.textContent = data.studentId;
        box.appendChild(idVal);

        var copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.textContent = "คัดลอกรหัส";
        copyBtn.addEventListener("click", function () {
          navigator.clipboard.writeText(data.studentId).then(function () {
            copyBtn.textContent = "คัดลอกแล้ว";
            setTimeout(function () {
              copyBtn.textContent = "คัดลอกรหัส";
            }, 2000);
          });
        });
        box.appendChild(copyBtn);

        resultEl.appendChild(box);
      }

      function showNotFound() {
        var box = document.createElement("div");
        var msg = document.createElement("p");
        msg.textContent = "ไม่พบข้อมูลนักศึกษาที่ตรงกับเลขบัตรนี้";
        box.appendChild(msg);
        resultEl.appendChild(box);
      }

      function clearResult() {
        while (resultEl.firstChild) resultEl.firstChild.remove();
      }

      input.focus();
    </script>
  </body>
</html>
